version: '3.8'

# 定义可重用的服务模板，避免重复
x-common-service: &common-service
  restart: always
  build:
    context: .
    dockerfile: Dockerfile
  networks:
    - ecommerce-net
  volumes:
    # 将本地的configs目录挂载到容器的/app/configs，实现配置热加载
    # 注意：SERVICE_NAME 变量在这里不可用，所以我们挂载整个目录
    - ./configs:/app/configs
  depends_on:
    mysql:
      condition: service_healthy
    redis:
      condition: service_healthy
    kafka:
      condition: service_started # Kafka没有简单的健康检查，所以等待启动

# 定义网络
networks:
  ecommerce-net:
    driver: bridge

services:
  # --- 基础架构服务 ---
  mysql:
    image: mysql:8.0
    container_name: ecommerce-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password # 注意: 'password' 仅用于本地开发环境，生产环境请使用更安全的密码管理方式。
      MYSQL_DATABASE: ecommerce_db
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.0-alpine
    container_name: ecommerce-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: ecommerce-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - ecommerce-net

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: ecommerce-kafka
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - ecommerce-net

  elasticsearch:
    image: elasticsearch:8.11.0
    container_name: ecommerce-elasticsearch
    restart: always
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false # 注意: 'xpack.security.enabled=false' 仅用于本地开发环境，生产环境请务必启用并配置安全。
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - ./data/elasticsearch:/usr/share/elasticsearch/data
    networks:
      - ecommerce-net

  # --- 微服务 ---
  # 使用YAML锚点来继承通用配置
  gateway:
    <<: *common-service
    container_name: ecommerce-gateway
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: gateway
    ports:
      - "8000:8000" # HTTP端口

  user:
    <<: *common-service
    container_name: ecommerce-user
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: user
    ports:
      - "8001:8000" # HTTP
      - "9001:9000" # gRPC

  product:
    <<: *common-service
    container_name: ecommerce-product
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: product
    ports:
      - "8002:8000"
      - "9002:9000"

  order:
    <<: *common-service
    container_name: ecommerce-order
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: order
    ports:
      - "8003:8000"
      - "9003:9000"

  # ... 可以按需添加其他服务
  # 例如:
  # cart:
  #   <<: *common-service
  #   container_name: ecommerce-cart
  #   build:
  #     args:
  #       SERVICE_NAME: cart
  #   ports:
  #     - "8004:8000"
  #     - "9004:9000"