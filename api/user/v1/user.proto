syntax = "proto3";

package api.user.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/go-api/user/v1;v1";

// 用户账号服务，管理用户注册、登录、个人资料及收货地址。
service User {
  // --- 账号核心接口 ---

  // 用户注册。
  rpc RegisterByPassword(RegisterByPasswordRequest) returns (RegisterResponse);
  // 用户登录并换取认证令牌。
  rpc LoginByPassword(LoginByPasswordRequest) returns (LoginByPasswordResponse);
  // 通过 ID 获取用户基础公开信息。
  rpc GetUserByID(GetUserByIDRequest) returns (UserResponse);
  // 修改当前用户的昵称、头像等资料。
  rpc UpdateUserInfo(UpdateUserInfoRequest) returns (UserResponse);

  // --- 地址簿管理 ---

  // 新增收货地址。
  rpc AddAddress(AddAddressRequest) returns (Address);
  // 获取单条地址详情。
  rpc GetAddress(GetAddressRequest) returns (Address);
  // 修改已有的收货地址。
  rpc UpdateAddress(UpdateAddressRequest) returns (Address);
  // 物理删除收货地址。
  rpc DeleteAddress(DeleteAddressRequest) returns (google.protobuf.Empty);
  // 查询用户名下的全部地址。
  rpc ListAddresses(ListAddressesRequest) returns (ListAddressesResponse);

  // --- 内部验证接口 ---

  // 内部鉴权调用：核对密码是否正确。
  rpc VerifyPassword(VerifyPasswordRequest) returns (VerifyPasswordResponse);
}

// 用户基础信息。
message UserInfo {
  // 用户 ID。
  uint64 user_id = 1;
  // 账号名。
  string username = 2;
  // 显示昵称。
  string nickname = 3;
  // 头像图片地址。
  string avatar = 4;
  // 性别 (1:男, 2:女)。
  int32 gender = 5;
  // 出生日期。
  google.protobuf.Timestamp birthday = 6;
}

// 注册请求。
message RegisterByPasswordRequest {
  // 登录名。
  string username = 1;
  // 明文或哈希后的初始密码。
  string password = 2;
}

// 注册响应。
message RegisterResponse {
  // 新用户的系统 ID。
  uint64 user_id = 1;
}

// 登录请求。
message LoginByPasswordRequest {
  // 用户名。
  string username = 1;
  // 凭证。
  string password = 2;
}

// 登录响应。
message LoginByPasswordResponse {
  // 身份令牌。
  string token = 1;
  // 到期时间戳。
  int64 expires_at = 2;
}

// 用户单查请求。
message GetUserByIDRequest {
  // 用户 ID。
  uint64 user_id = 1;
}

// 用户信息响应。
message UserResponse {
  // 用户实体。
  UserInfo user = 1;
}

// 资料更新请求。
message UpdateUserInfoRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 新昵称。
  optional string nickname = 2;
  // 新头像。
  optional string avatar = 3;
  // 性别变更。
  optional int32 gender = 4;
  // 生日变更。
  optional google.protobuf.Timestamp birthday = 5;
}

// 收货地址。
message Address {
  // 地址记录 ID。
  uint64 id = 1;
  // 用户 ID。
  uint64 user_id = 2;
  // 姓名。
  string name = 3;
  // 联系手机号。
  string phone = 4;
  // 省份。
  string province = 5;
  // 城市。
  string city = 6;
  // 区县。
  string district = 7;
  // 门牌号及详细描述。
  string detailed_address = 8;
  // 是否默认。
  bool is_default = 9;
}

// 新增地址请求。
message AddAddressRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 收件人。
  string name = 2;
  // 电话。
  string phone = 3;
  // 行政区划。
  string province = 4;
  string city = 5;
  string district = 6;
  // 详细地址。
  string detailed_address = 7;
  // 是否设为默认。
  optional bool is_default = 8;
}

// 地址单查请求。
message GetAddressRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 地址 ID。
  uint64 id = 2;
}

// 地址更新请求。
message UpdateAddressRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 地址 ID。
  uint64 id = 2;
  // 变更项。
  optional string name = 3;
  optional string phone = 4;
  optional string province = 5;
  optional string city = 6;
  optional string district = 7;
  optional string detailed_address = 8;
  optional bool is_default = 9;
}

// 地址删除。
message DeleteAddressRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 地址 ID。
  uint64 id = 2;
}

// 用户地址簿列表请求。
message ListAddressesRequest {
  // 用户 ID。
  uint64 user_id = 1;
}

// 用户地址簿列表响应。
message ListAddressesResponse {
  // 地址集合。
  repeated Address addresses = 1;
}

// 内部验密请求。
message VerifyPasswordRequest {
  // 账号。
  string username = 1;
  // 待核对密码。
  string password = 2;
}

// 内部验密结果。
message VerifyPasswordResponse {
  // 是否匹配。
  bool success = 1;
  // 匹配成功时的用户信息快照。
  UserInfo user = 2;
}
