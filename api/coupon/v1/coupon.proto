syntax = "proto3";

package api.coupon.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/coupon/v1;couponv1";

// 优惠券服务，提供券模板管理、用户领券及核销功能。
service CouponService {
  // 创建新的优惠券活动模板。
  rpc CreateCoupon(CreateCouponRequest) returns (CouponResponse);

  // 获取特定优惠券模板的配置。
  rpc GetCouponByID(GetCouponByIDRequest) returns (CouponResponse);

  // 修改优惠券活动参数。
  rpc UpdateCoupon(UpdateCouponRequest) returns (CouponResponse);

  // 终止或物理删除优惠券。
  rpc DeleteCoupon(DeleteCouponRequest) returns (google.protobuf.Empty);

  // 将一张优惠券发放给指定用户。
  rpc IssueCoupon(IssueCouponRequest) returns (UserCouponResponse);

  // 查询用户账户内持有的优惠券列表。
  rpc GetUserCoupons(GetUserCouponsRequest) returns (GetUserCouponsResponse);

  // 在支付环节核销优惠券。
  rpc UseCoupon(UseCouponRequest) returns (UserCouponResponse);
}

// 优惠券模板信息。
message CouponInfo {
  // 模板 ID。
  uint64 coupon_id = 1;
  // 业务券码。
  string code = 2;
  // 显示标题。
  string name = 3;
  // 详情介绍。
  string description = 4;
  // 减免类型 (PERCENTAGE, CASH)。
  string discount_type = 5;
  // 减免数值。
  double discount_value = 6;
  // 满减门槛金额。
  double min_order_amount = 7;
  // 有效期开始。
  google.protobuf.Timestamp valid_from = 8;
  // 有效期截止。
  google.protobuf.Timestamp valid_until = 9;
  // 总预算张数。
  int32 total_quantity = 10;
  // 已派发张数。
  int32 issued_quantity = 11;
}

// 用户持有券详情。
message UserCouponInfo {
  // 持有记录 ID。
  uint64 user_coupon_id = 1;
  // 所属用户 ID。
  uint64 user_id = 2;
  // 关联模板 ID。
  uint64 coupon_id = 3;
  // 券业务码快照。
  string code = 4;
  // 使用状态 (UNUSED, USED, EXPIRED)。
  string status = 5;
  // 领券时间。
  google.protobuf.Timestamp issued_at = 6;
  // 核销时间（若已用）。
  optional google.protobuf.Timestamp used_at = 7;
}

// 创建模板请求。
message CreateCouponRequest {
  // 业务码。
  string code = 1;
  // 名称。
  string name = 2;
  // 描述。
  string description = 3;
  // 类型。
  string discount_type = 4;
  // 数值。
  double discount_value = 5;
  // 门槛。
  double min_order_amount = 6;
  // 开始日期。
  google.protobuf.Timestamp valid_from = 7;
  // 截止日期。
  google.protobuf.Timestamp valid_until = 8;
  // 总量。
  int32 total_quantity = 9;
}

// 创建结果。
message CouponResponse {
  // 模板档案。
  CouponInfo coupon = 1;
}

// ID 查询请求。
message GetCouponByIDRequest {
  // 系统 ID。
  uint64 coupon_id = 1;
}

// 修改请求。
message UpdateCouponRequest {
  // 系统 ID。
  uint64 coupon_id = 1;
  // 标题修改。
  optional string name = 2;
  // 描述修改。
  optional string description = 3;
  // 类型修改。
  optional string discount_type = 4;
  // 数值修改。
  optional double discount_value = 5;
  // 门槛修改。
  optional double min_order_amount = 6;
  // 生效日期修改。
  optional google.protobuf.Timestamp valid_from = 7;
  // 失效日期修改。
  optional google.protobuf.Timestamp valid_until = 8;
  // 库存修改。
  optional int32 total_quantity = 9;
}

// 删除请求。
message DeleteCouponRequest {
  // 系统 ID。
  uint64 coupon_id = 1;
}

// 发放请求。
message IssueCouponRequest {
  // 目标模板。
  uint64 coupon_id = 1;
  // 目标用户。
  uint64 user_id = 2;
}

// 发放结果。
message UserCouponResponse {
  // 用户券对象。
  UserCouponInfo user_coupon = 1;
}

// 个人券查询请求。
message GetUserCouponsRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 状态筛选。
  optional string status = 2;
}

// 个人券列表响应。
message GetUserCouponsResponse {
  // 用户持有的券序列。
  repeated UserCouponInfo user_coupons = 1;
}

// 核销请求。
message UseCouponRequest {
  // 持有记录 ID。
  uint64 user_coupon_id = 1;
  // 使用者。
  uint64 user_id = 2;
  // 关联订单。
  uint64 order_id = 3;
}
