syntax = "proto3";

package api.order.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/order/v1;orderv1";

// 订单主流程状态。
enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  PENDING_PAYMENT = 1; // 待支付
  PAID = 2; // 已支付，待发货
  SHIPPED = 3; // 已发货，运输中
  DELIVERED = 4; // 包裹已签收
  COMPLETED = 5; // 用户确认收货，流程完成
  CANCELLED = 6; // 订单已取消
  REFUND_REQUESTED = 7; // 退款审核中
  REFUNDED = 8; // 退款已到账
  CLOSED = 9; // 异常或超时关闭
}

// 订单支付环节状态。
enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  UNPAID = 1; // 未付款
  PROCESSING = 2; // 支付处理中
  SUCCESS = 3; // 付款成功
  FAILED = 4; // 付款失败
  REFUNDING = 5; // 退款执行中
  REFUND_SUCCESS = 6; // 退款已成功
  REFUND_FAILED = 7; // 退款执行失败
}

// 订单履约配送状态。
enum ShippingStatus {
  SHIPPING_STATUS_UNSPECIFIED = 0;
  PENDING_SHIPMENT = 1; // 仓库准备中
  SHIPPING_SHIPPED = 2; // 已出库发货
  IN_TRANSIT = 3; // 干线运输中
  SHIPPING_DELIVERED = 4; // 快递员派送完成
  EXCEPTION = 5; // 配送异常（拒收、丢失等）
}

// 订单管理服务，负责订单生命周期、支付及退款流程协调。
service OrderService {
  // 创建新订单。
  rpc CreateOrder(CreateOrderRequest) returns (OrderInfo);

  // 通过 ID 查询订单全量信息。
  rpc GetOrderByID(GetOrderByIDRequest) returns (OrderInfo);

  // 修改订单状态（需符合业务状态机流转规则）。
  rpc UpdateOrderStatus(UpdateOrderStatusRequest) returns (OrderInfo);

  // 用户或系统撤销处于可取消状态的订单。
  rpc CancelOrder(CancelOrderRequest) returns (OrderInfo);

  // 分页列表查询并筛选订单。
  rpc ListOrders(ListOrdersRequest) returns (ListOrdersResponse);

  // 内部接口：接收并处理支付结果回调。
  rpc ProcessPayment(ProcessPaymentRequest) returns (PaymentResult);

  // 发起订单退款流程。
  rpc RequestRefund(RequestRefundRequest) returns (OrderInfo);

  // 内部调用：查询特定订单包含的所有商品项明细。
  rpc GetOrderItemsByOrderID(GetOrderItemsByOrderIDRequest) returns (GetOrderItemsByOrderIDResponse);

  // 物流更新：同步修改订单的配送阶段状态。
  rpc UpdateOrderShippingStatus(UpdateOrderShippingStatusRequest) returns (OrderInfo);
}

// 订单全量档案。
message OrderInfo {
  // 系统 ID。
  uint64 id = 1;
  // 业务显示编号。
  string order_no = 2;
  // 用户 ID。
  uint64 user_id = 3;
  // 主流程状态。
  OrderStatus status = 4;
  // 支付环节状态。
  PaymentStatus payment_status = 5;
  // 物流环节状态。
  ShippingStatus shipping_status = 6;
  // 应付总额（含运费）。
  int64 total_amount = 7;
  // 实付总额（扣除优惠）。
  int64 actual_amount = 8;
  // 运费金额。
  int64 shipping_fee = 9;
  // 优惠减免总额。
  int64 discount_amount = 10;
  // 支付通道名 (WECHAT, ALIPAY)。
  string payment_method = 11;
  // 下单日期。
  google.protobuf.Timestamp created_at = 12;
  // 修改日期。
  google.protobuf.Timestamp updated_at = 13;
  // 付款完成日期。
  google.protobuf.Timestamp paid_at = 14;
  // 发货日期。
  google.protobuf.Timestamp shipped_at = 15;
  // 签收日期。
  google.protobuf.Timestamp delivered_at = 16;
  // 确认收货日期。
  google.protobuf.Timestamp completed_at = 17;
  // 取消日期。
  google.protobuf.Timestamp cancelled_at = 18;
  // 买家留言。
  string remark = 19;
  // 收货地址。
  ShippingAddress shipping_address = 20;
  // 商品清单。
  repeated OrderItem items = 21;
  // 流程节点变更日志。
  repeated OrderLog logs = 22;
}

// 订单包含的商品。
message OrderItem {
  // 明细 ID。
  uint64 id = 1;
  // 所属订单。
  uint64 order_id = 2;
  // 主商品 ID。
  uint64 product_id = 3;
  // 具体规格 ID。
  uint64 sku_id = 4;
  // 商品标题。
  string product_name = 5;
  // 规格展示名。
  string sku_name = 6;
  // 缩略图。
  string product_image_url = 7;
  // 购买单价（分）。
  int64 price = 8;
  // 购买数量。
  int32 quantity = 9;
  // 该项小计（分）。
  int64 total_price = 10;
}

// 收货信息快照。
message ShippingAddress {
  // 收件人姓名。
  string recipient_name = 1;
  // 联系手机号。
  string phone_number = 2;
  // 省。
  string province = 3;
  // 市。
  string city = 4;
  // 区。
  string district = 5;
  // 详细门牌。
  string detailed_address = 6;
  // 邮编。
  string postal_code = 7;
}

// 状态流转日志。
message OrderLog {
  // 日志 ID。
  uint64 id = 1;
  // 订单 ID。
  uint64 order_id = 2;
  // 操作人 (USER, ADMIN, SYSTEM)。
  string operator = 3;
  // 动作描述（如 "支付确认"）。
  string action = 4;
  // 变更前状态。
  string old_status = 5;
  // 变更后新状态。
  string new_status = 6;
  // 发生时间。
  google.protobuf.Timestamp created_at = 7;
}

// 支付结果回执。
message PaymentResult {
  // 订单 ID。
  uint64 order_id = 1;
  // 支付平台流水号。
  string transaction_id = 2;
  // 支付状态。
  PaymentStatus status = 3;
  // 错误或提示消息。
  string message = 4;
  // 实际支付完成日期。
  google.protobuf.Timestamp paid_at = 5;
}

// 下单请求。
message CreateOrderRequest {
  // 买家 ID。
  uint64 user_id = 1;
  // 待购商品列表。
  repeated OrderItemCreate items = 2;
  // 目标地址。
  ShippingAddress shipping_address = 3;
  // 买家备注。
  string remark = 4;
  // 支付方式。
  string payment_method = 5;
  // 选用的优惠券。
  google.protobuf.StringValue coupon_code = 6;
}

// 待购项模板。
message OrderItemCreate {
  // 商品 SPU ID。
  uint64 product_id = 1;
  // 规格 SKU ID。
  uint64 sku_id = 2;
  // 数量。
  int32 quantity = 3;
}

// ID 查询请求。
message GetOrderByIDRequest {
  // 系统 ID。
  uint64 id = 1;
  // 鉴权 ID。
  uint64 user_id = 2;
}

// 状态干预请求。
message UpdateOrderStatusRequest {
  // 系统 ID。
  uint64 id = 1;
  // 用户 ID。
  uint64 user_id = 2;
  // 目标状态。
  OrderStatus new_status = 3;
  // 操作人。
  string operator = 4;
  // 修改备注。
  string remark = 5;
}

// 撤单请求。
message CancelOrderRequest {
  // 系统 ID。
  uint64 id = 1;
  // 用户 ID。
  uint64 user_id = 2;
  // 取消原因描述。
  string reason = 3;
}

// 列表检索请求。
message ListOrdersRequest {
  // 页码。
  int32 page = 1;
  // 数量。
  int32 page_size = 2;
  // 买家过滤。
  uint64 user_id = 3;
  // 状态过滤。
  OrderStatus status = 4;
  // 时间范围。
  google.protobuf.Timestamp start_time = 5;
  google.protobuf.Timestamp end_time = 6;
  // 排序规则。
  string sort_by = 7;
}

// 列表检索响应。
message ListOrdersResponse {
  // 结果列表。
  repeated OrderInfo orders = 1;
  // 总记录数。
  int32 total = 2;
  // 当前页码。
  int32 page = 3;
  // 翻页限制。
  int32 page_size = 4;
}

// 支付结果同步请求。
message ProcessPaymentRequest {
  // 关联订单。
  uint64 order_id = 1;
  // 用户 ID。
  uint64 user_id = 2;
  // 支付通道。
  string payment_method = 3;
  // 实付总额。
  int64 amount = 4;
  // 外部流水号。
  string transaction_id = 5;
}

// 退款申请请求。
message RequestRefundRequest {
  // 目标订单。
  uint64 order_id = 1;
  // 鉴权用户。
  uint64 user_id = 2;
  // 申请退款总额。
  int64 refund_amount = 3;
  // 退款理由描述。
  string reason = 4;
}

// 项明细请求。
message GetOrderItemsByOrderIDRequest {
  // 订单 ID。
  uint64 order_id = 1;
}

// 项明细响应。
message GetOrderItemsByOrderIDResponse {
  // 明细集合。
  repeated OrderItem items = 1;
}

// 物流状态同步请求。
message UpdateOrderShippingStatusRequest {
  // 关联订单。
  uint64 order_id = 1;
  // 新的履约状态。
  ShippingStatus new_shipping_status = 2;
  // 快递单号。
  string tracking_number = 3;
  // 物流商名称。
  string logistics_company = 4;
  // 录入人。
  string operator = 5;
}
