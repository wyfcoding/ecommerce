syntax = "proto3";

package api.payment.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/wyfcoding/ecommerce/go-api/payment/v1;v1";

// PaymentStatus 支付交易状态枚举
enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0; // 未指定
  PENDING = 1;                    // 待支付/处理中
  SUCCESS = 2;                    // 支付成功
  FAILED = 3;                     // 支付失败
  REFUNDING = 4;                  // 退款中
  REFUNDED = 5;                   // 已退款
  CLOSED = 6;                     // 交易关闭 (例如超时未支付)
}

// RefundStatus 退款交易状态枚举
enum RefundStatus {
  REFUND_STATUS_UNSPECIFIED = 0; // 未指定
  PENDING_REFUND = 1;            // 退款申请中/处理中
  REFUND_SUCCESS = 2;            // 退款成功
  REFUND_FAILED = 3;             // 退款失败
  REFUND_CLOSED = 4;             // 退款关闭
}

// Payment 支付服务定义了所有与支付、退款和支付网关集成相关的RPC接口。
service Payment {
  // InitiatePayment 发起一笔支付请求。
  // 返回支付所需的参数，例如支付URL、二维码等。
  rpc InitiatePayment(InitiatePaymentRequest) returns (PaymentResponse);

  // HandlePaymentCallback 处理支付网关的回调通知。
  // 支付网关通常会异步通知支付结果。
  rpc HandlePaymentCallback(HandlePaymentCallbackRequest) returns (google.protobuf.Empty);

  // GetPaymentStatus 查询支付交易状态。
  rpc GetPaymentStatus(GetPaymentStatusRequest) returns (PaymentTransaction);

  // RequestRefund 发起一笔退款请求。
  rpc RequestRefund(RequestRefundRequest) returns (RefundTransaction);

  // HandleRefundCallback 处理退款网关的回调通知。
  rpc HandleRefundCallback(HandleRefundCallbackRequest) returns (google.protobuf.Empty);

  // GetRefundStatus 查询退款交易状态。
  rpc GetRefundStatus(GetRefundStatusRequest) returns (RefundTransaction);

  // ListPaymentTransactions 列出支付交易记录。
  rpc ListPaymentTransactions(ListPaymentTransactionsRequest) returns (ListPaymentTransactionsResponse);

  // ListRefundTransactions 列出退款交易记录。
  rpc ListRefundTransactions(ListRefundTransactionsRequest) returns (ListRefundTransactionsResponse);
}

// --- 核心消息定义 ---

// PaymentTransaction 代表一笔支付交易的详细信息。
message PaymentTransaction {
  uint64 id = 1;                                  // 支付交易ID
  string transaction_no = 2;                      // 支付交易编号 (内部唯一)
  uint64 order_id = 3;                            // 关联的订单ID
  uint64 user_id = 4;                             // 用户ID
  string payment_method = 5;                      // 支付方式 (例如: "WeChatPay", "Alipay", "CreditCard")
  int64 amount = 6;                               // 支付金额 (单位: 分)
  PaymentStatus status = 7;                       // 支付交易状态
  string gateway_transaction_id = 8;              // 支付网关的交易ID
  string gateway_response = 9;                    // 支付网关的原始响应 (JSON)
  google.protobuf.Timestamp created_at = 10;      // 交易创建时间
  google.protobuf.Timestamp updated_at = 11;      // 最后更新时间
  google.protobuf.Timestamp paid_at = 12;         // 支付成功时间
  google.protobuf.Timestamp closed_at = 13;       // 交易关闭时间
  string currency = 14;                           // 货币类型 (例如: CNY)
}

// RefundTransaction 代表一笔退款交易的详细信息。
message RefundTransaction {
  uint64 id = 1;                                  // 退款交易ID
  string refund_no = 2;                           // 退款交易编号 (内部唯一)
  uint64 payment_transaction_id = 3;              // 关联的支付交易ID
  uint64 order_id = 4;                            // 关联的订单ID
  uint64 user_id = 5;                             // 用户ID
  int64 refund_amount = 6;                        // 退款金额 (单位: 分)
  RefundStatus status = 7;                        // 退款交易状态
  string gateway_refund_id = 8;                   // 支付网关的退款ID
  string gateway_response = 9;                    // 支付网关的原始响应 (JSON)
  string reason = 10;                             // 退款原因
  google.protobuf.Timestamp created_at = 11;      // 退款申请时间
  google.protobuf.Timestamp updated_at = 12;      // 最后更新时间
  google.protobuf.Timestamp refunded_at = 13;     // 退款成功时间
  google.protobuf.Timestamp closed_at = 14;       // 退款关闭时间
}

// PaymentResponse 支付发起后的响应，包含支付所需信息。
message PaymentResponse {
  string payment_url = 1;                         // 支付跳转URL或二维码内容
  string prepay_id = 2;                           // 预支付ID (例如微信支付)
  string app_id = 3;                              // 应用ID (例如微信支付)
  string partner_id = 4;                          // 商户ID (例如微信支付)
  string package_value = 5;                       // 包值 (例如微信支付)
  string nonce_str = 6;                           // 随机字符串 (例如微信支付)
  string timestamp = 7;                           // 时间戳 (例如微信支付)
  string sign = 8;                                // 签名 (例如微信支付)
  string transaction_no = 9;                      // 内部支付交易编号
}

// --- RPC 请求/响应 消息 ---

// InitiatePaymentRequest 发起支付请求。
message InitiatePaymentRequest {
  uint64 order_id = 1;                            // 订单ID
  uint64 user_id = 2;                             // 用户ID
  string payment_method = 3;                      // 支付方式 (例如: "WeChatPay", "Alipay")
  int64 amount = 4;                               // 支付金额 (单位: 分)
  string client_ip = 5;                           // 客户端IP地址
  string return_url = 6;                          // 支付成功后的回调URL
}

// HandlePaymentCallbackRequest 处理支付网关回调的请求。
// 实际参数会根据不同的支付网关而异，这里使用通用结构。
message HandlePaymentCallbackRequest {
  string payment_method = 1;                      // 支付方式
  map<string, string> callback_data = 2;          // 支付网关回调的原始数据
}

// GetPaymentStatusRequest 查询支付状态的请求。
message GetPaymentStatusRequest {
  uint64 payment_transaction_id = 1;              // 内部支付交易ID
  google.protobuf.StringValue transaction_no = 2; // 内部支付交易编号 (可选)
  google.protobuf.StringValue gateway_transaction_id = 3; // 支付网关交易ID (可选)
}

// RequestRefundRequest 发起退款请求。
message RequestRefundRequest {
  uint64 payment_transaction_id = 1;              // 关联的支付交易ID
  uint64 order_id = 2;                            // 关联的订单ID
  uint64 user_id = 3;                             // 用户ID
  int64 refund_amount = 4;                        // 退款金额 (单位: 分)
  string reason = 5;                              // 退款原因
}

// HandleRefundCallbackRequest 处理退款网关回调的请求。
message HandleRefundCallbackRequest {
  string payment_method = 1;                      // 支付方式
  map<string, string> callback_data = 2;          // 退款网关回调的原始数据
}

// GetRefundStatusRequest 查询退款状态的请求。
message GetRefundStatusRequest {
  uint64 refund_transaction_id = 1;               // 内部退款交易ID
  google.protobuf.StringValue refund_no = 2;      // 内部退款交易编号 (可选)
  google.protobuf.StringValue gateway_refund_id = 3; // 支付网关退款ID (可选)
}

// ListPaymentTransactionsRequest 列出支付交易记录的请求。
message ListPaymentTransactionsRequest {
  int32 page = 1; // 页码
  int32 page_size = 2; // 页码大小
  uint64 user_id = 3;                             // 按用户ID筛选
  uint64 order_id = 4;                            // 按订单ID筛选
  PaymentStatus status = 5;                       // 按支付状态筛选
  google.protobuf.Timestamp start_time = 6;       // 交易创建时间范围开始
  google.protobuf.Timestamp end_time = 7;         // 交易创建时间范围结束
}

// ListPaymentTransactionsResponse 列出支付交易记录的响应。
message ListPaymentTransactionsResponse {
  repeated PaymentTransaction transactions = 1; // 事务列表
  int32 total = 2; // 总数
  int32 page = 3; // 页码
  int32 page_size = 4; // 页码大小
}

// ListRefundTransactionsRequest 列出退款交易记录的请求。
message ListRefundTransactionsRequest {
  int32 page = 1; // 页码
  int32 page_size = 2; // 页码大小
  uint64 user_id = 3;                             // 按用户ID筛选
  uint64 order_id = 4;                            // 按订单ID筛选
  RefundStatus status = 5;                        // 按退款状态筛选
  google.protobuf.Timestamp start_time = 6;       // 退款创建时间范围开始
  google.protobuf.Timestamp end_time = 7;         // 退款创建时间范围结束
}

// ListRefundTransactionsResponse 列出退款交易记录的响应。
message ListRefundTransactionsResponse {
  repeated RefundTransaction transactions = 1; // 事务列表
  int32 total = 2; // 总数
  int32 page = 3; // 页码
  int32 page_size = 4; // 页码大小
}
