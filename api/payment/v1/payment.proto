syntax = "proto3";

package api.payment.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/wyfcoding/ecommerce/go-api/payment/v1;v1";

// 支付流水状态。
enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PENDING = 1; // 支付中
  SUCCESS = 2; // 支付成功
  FAILED = 3; // 支付失败
  REFUNDING = 4; // 退款中
  REFUNDED = 5; // 已全额退款
  CLOSED = 6; // 支付已关闭
}

// 退款申请状态。
enum RefundStatus {
  REFUND_STATUS_UNSPECIFIED = 0;
  PENDING_REFUND = 1; // 处理中
  REFUND_SUCCESS = 2; // 退款成功
  REFUND_FAILED = 3; // 退款失败
  REFUND_CLOSED = 4; // 退款已关
}

// 支付服务，处理收银台调起、第三方支付回调、退款申请及支付对账。
service Payment {
  // 创建支付单，获取支付链接或二维码参数。
  rpc InitiatePayment(InitiatePaymentRequest) returns (PaymentResponse);

  // 接收并验证第三方支付渠道（如微信、支付宝）的异步回调。
  rpc HandlePaymentCallback(HandlePaymentCallbackRequest) returns (google.protobuf.Empty);

  // 实时查询支付单的最新状态。
  rpc GetPaymentStatus(GetPaymentStatusRequest) returns (PaymentTransaction);

  // 针对已成功的支付发起退款申请。
  rpc RequestRefund(RequestRefundRequest) returns (RefundTransaction);

  // 接收并处理退款操作的异步结果回调。
  rpc HandleRefundCallback(HandleRefundCallbackRequest) returns (google.protobuf.Empty);

  // 查询退款任务的执行进度。
  rpc GetRefundStatus(GetRefundStatusRequest) returns (RefundTransaction);

  // 分页列出系统的支付历史记录。
  rpc ListPaymentTransactions(ListPaymentTransactionsRequest) returns (ListPaymentTransactionsResponse);

  // 分页列出系统的退款历史记录。
  rpc ListRefundTransactions(ListRefundTransactionsRequest) returns (ListRefundTransactionsResponse);
}

// 支付流水明细。
message PaymentTransaction {
  // 流水 ID。
  uint64 id = 1;
  // 内部交易号。
  string transaction_no = 2;
  // 关联订单 ID。
  uint64 order_id = 3;
  // 付款用户 ID。
  uint64 user_id = 4;
  // 支付方式 (WECHAT, ALIPAY)。
  string payment_method = 5;
  // 支付金额（分）。
  int64 amount = 6;
  // 状态。
  PaymentStatus status = 7;
  // 第三方渠道流水号。
  string gateway_transaction_id = 8;
  // 渠道端原始 JSON。
  string gateway_response = 9;
  // 记录生成时间。
  google.protobuf.Timestamp created_at = 10;
  // 修改时间。
  google.protobuf.Timestamp updated_at = 11;
  // 支付确认时间。
  google.protobuf.Timestamp paid_at = 12;
  // 结单/关闭时间。
  google.protobuf.Timestamp closed_at = 13;
  // 币种。
  string currency = 14;
}

// 退款流水明细。
message RefundTransaction {
  // 退款 ID。
  uint64 id = 1;
  // 内部退款号。
  string refund_no = 2;
  // 关联原支付流水 ID。
  uint64 payment_transaction_id = 3;
  // 关联原订单 ID。
  uint64 order_id = 4;
  // 退款用户 ID。
  uint64 user_id = 5;
  // 退款金额（分）。
  int64 refund_amount = 6;
  // 状态。
  RefundStatus status = 7;
  // 第三方退款单号。
  string gateway_refund_id = 8;
  // 渠道原始响应。
  string gateway_response = 9;
  // 退款理由。
  string reason = 10;
  // 申请时间。
  google.protobuf.Timestamp created_at = 11;
  // 修改时间。
  google.protobuf.Timestamp updated_at = 12;
  // 成功时间。
  google.protobuf.Timestamp refunded_at = 13;
  // 完结时间。
  google.protobuf.Timestamp closed_at = 14;
}

// 支付拉起响应。
message PaymentResponse {
  // 外部支付跳转地址。
  string payment_url = 1;
  // 预支付凭证。
  string prepay_id = 2;
  // 微信/支付宝 AppID。
  string app_id = 3;
  // 商户号。
  string partner_id = 4;
  // 签名包。
  string package_value = 5;
  // 随机串。
  string nonce_str = 6;
  // 时间戳。
  string timestamp = 7;
  // 签名摘要。
  string sign = 8;
  // 内部流水号。
  string transaction_no = 9;
}

// 发起请求。
message InitiatePaymentRequest {
  // 订单 ID。
  uint64 order_id = 1;
  // 用户 ID。
  uint64 user_id = 2;
  // 方式。
  string payment_method = 3;
  // 金额（分）。
  int64 amount = 4;
  // 发起端 IP。
  string client_ip = 5;
  // 前端同步回跳地址。
  string return_url = 6;
}

// 回调处理请求。
message HandlePaymentCallbackRequest {
  // 支付方式。
  string payment_method = 1;
  // 渠道传回的所有参数映射。
  map<string, string> callback_data = 2;
}

// 状态查询。
message GetPaymentStatusRequest {
  // 内部流水 ID。
  uint64 payment_transaction_id = 1;
  // 内部流水号。
  google.protobuf.StringValue transaction_no = 2;
  // 渠道流水号。
  google.protobuf.StringValue gateway_transaction_id = 3;
}

// 退款请求。
message RequestRefundRequest {
  // 原流水 ID。
  uint64 payment_transaction_id = 1;
  // 订单 ID。
  uint64 order_id = 2;
  // 用户 ID。
  uint64 user_id = 3;
  // 退款金额。
  int64 refund_amount = 4;
  // 理由。
  string reason = 5;
}

// 退款回调请求。
message HandleRefundCallbackRequest {
  // 方式。
  string payment_method = 1;
  // 渠道返回数据。
  map<string, string> callback_data = 2;
}

// 退款查询。
message GetRefundStatusRequest {
  // 内部退款 ID。
  uint64 refund_transaction_id = 1;
  // 内部退款号。
  google.protobuf.StringValue refund_no = 2;
  // 渠道退款 ID。
  google.protobuf.StringValue gateway_refund_id = 3;
}

// 流水列表查询。
message ListPaymentTransactionsRequest {
  // 页码。
  int32 page = 1;
  // 数量。
  int32 page_size = 2;
  // 用户。
  uint64 user_id = 3;
  // 订单。
  uint64 order_id = 4;
  // 状态。
  PaymentStatus status = 5;
  // 开始日期。
  google.protobuf.Timestamp start_time = 6;
  // 结束日期。
  google.protobuf.Timestamp end_time = 7;
}

// 流水列表响应。
message ListPaymentTransactionsResponse {
  // 流水记录。
  repeated PaymentTransaction transactions = 1;
  // 总笔数。
  int32 total = 2;
  // 当前页。
  int32 page = 3;
  // 翻页限制。
  int32 page_size = 4;
}

// 退款记录列表请求。
message ListRefundTransactionsRequest {
  // 页码。
  int32 page = 1;
  // 数量。
  int32 page_size = 2;
  // 用户。
  uint64 user_id = 3;
  // 订单。
  uint64 order_id = 4;
  // 状态。
  RefundStatus status = 5;
  // 开始日期。
  google.protobuf.Timestamp start_time = 6;
  // 结束日期。
  google.protobuf.Timestamp end_time = 7;
}

// 退款记录列表响应。
message ListRefundTransactionsResponse {
  // 退款记录。
  repeated RefundTransaction transactions = 1;
  // 总记录。
  int32 total = 2;
  // 当前页。
  int32 page = 3;
  // 翻页限制。
  int32 page_size = 4;
}
