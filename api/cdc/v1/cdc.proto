syntax = "proto3";

package api.cdc.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/cdc/v1;cdcv1";

// 变更数据捕获服务，负责监控数据库变更事件并分发给下游系统。
service CDCService {
  // 记录一次数据库的增删改变更。
  rpc CaptureChange(CaptureChangeRequest) returns (google.protobuf.Empty);

  // 实时订阅数据变更事件流。
  rpc StreamChanges(StreamChangesRequest) returns (stream ChangeEvent);
}

// 变更事件详情。
message ChangeEvent {
  // 物理表名。
  string table_name = 1;
  // 操作类型 (INSERT, UPDATE, DELETE)。
  string operation_type = 2;
  // 变更前的字段映射。
  map<string, string> old_data = 3;
  // 变更后的字段映射。
  map<string, string> new_data = 4;
  // 变更发生的时间戳。
  google.protobuf.Timestamp change_timestamp = 5;
}

// 捕获请求。
message CaptureChangeRequest {
  // 表名。
  string table_name = 1;
  // 类型。
  string operation_type = 2;
  // 旧数据。
  map<string, string> old_data = 3;
  // 新数据。
  map<string, string> new_data = 4;
}

// 订阅请求。
message StreamChangesRequest {
  // 需要监控的表名列表。
  repeated string table_names = 1;
  // 起始追溯时间。
  optional google.protobuf.Timestamp since_timestamp = 2;
}
