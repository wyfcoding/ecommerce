syntax = "proto3";

package api.analytics.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/analytics/v1;v1";

// 数据分析服务，负责收集用户行为数据并提供各类业务分析报告。
service Analytics {
  // --- 事件跟踪 ---

  // 上报单个行为事件（如页面浏览、按钮点击）。
  rpc TrackEvent(TrackEventRequest) returns (google.protobuf.Empty);

  // 批量上报多个行为事件，优化传输效率。
  rpc BatchTrackEvents(BatchTrackEventsRequest) returns (google.protobuf.Empty);

  // --- 数据查询与报告 ---

  // 查询指定用户的详细活动轨迹日志。
  rpc GetUserActivityReport(GetUserActivityReportRequest) returns (UserActivityReportResponse);

  // 分析商品的点击、加购及最终转化等表现指标。
  rpc GetProductPerformanceReport(GetProductPerformanceReportRequest) returns (ProductPerformanceReportResponse);

  // 提供宏观销售额、订单量等全局数据的汇总报告。
  rpc GetSalesOverviewReport(GetSalesOverviewReportRequest) returns (SalesOverviewReportResponse);

  // 分析用户在关键转化路径上的流失与漏斗表现。
  rpc GetConversionFunnelReport(GetConversionFunnelReportRequest) returns (ConversionFunnelReportResponse);

  // 允许根据业务需求灵活定义并查询自定义数据报告。
  rpc GetCustomReport(GetCustomReportRequest) returns (CustomReportResponse);

  // --- 用户行为分析 ---

  // 追踪并在用户群中识别典型的访问路径模式。
  rpc GetUserBehaviorPath(GetUserBehaviorPathRequest) returns (UserBehaviorPathResponse);

  // 根据行为特征或属性标签对用户进行分群。
  rpc GetUserSegments(GetUserSegmentsRequest) returns (UserSegmentsResponse);

  // --- 实时数据 ---

  // 查询当前全站在线的实时访客总数。
  rpc GetRealtimeVisitors(google.protobuf.Empty) returns (RealtimeVisitorsResponse);
}

// 事件分类枚举。
enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_PAGE_VIEW = 1; // 页面浏览
  EVENT_TYPE_PRODUCT_VIEW = 2; // 商品详情页浏览
  EVENT_TYPE_ADD_TO_CART = 3; // 加入购物车
  EVENT_TYPE_CHECKOUT_START = 4; // 开始结算
  EVENT_TYPE_PURCHASE = 5; // 支付购买
  EVENT_TYPE_LOGIN = 6; // 登录
  EVENT_TYPE_REGISTER = 7; // 注册
  EVENT_TYPE_SEARCH = 8; // 搜索
  EVENT_TYPE_CLICK = 9; // 点击
  EVENT_TYPE_CUSTOM = 10; // 自定义埋点
}

// 附加属性。
message EventProperty {
  // 键名。
  string key = 1;
  // 属性值。
  string value = 2;
}

// 行为事件实体。
message Event {
  // 事件名称标识。
  string event_name = 1;
  // 类型。
  EventType event_type = 2;
  // 关联用户。
  uint64 user_id = 3;
  // 会话唯一 ID。
  string session_id = 4;
  // 设备指纹 ID。
  string device_id = 5;
  // 来源 IP。
  string ip_address = 6;
  // 浏览器/客户端信息。
  string user_agent = 7;
  // 触发页面 URL。
  string page_url = 8;
  // 发生时间。
  google.protobuf.Timestamp timestamp = 9;
  // 自定义扩展属性。
  map<string, string> properties = 10;
}

// 单事件请求。
message TrackEventRequest {
  // 事件数据。
  Event event = 1;
}

// 批量事件请求。
message BatchTrackEventsRequest {
  // 事件集合。
  repeated Event events = 1;
}

// 轨迹查询请求。
message GetUserActivityReportRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 查询起始。
  google.protobuf.Timestamp start_date = 2;
  // 查询截止。
  google.protobuf.Timestamp end_date = 3;
  // 分页大小。
  int32 page_size = 4;
  // 分页令牌。
  int32 page_token = 5;
}

// 轨迹报告响应。
message UserActivityReportResponse {
  // 活动序列。
  repeated UserActivity activities = 1;
  // 总笔数。
  int32 total_count = 2;
  // 下一页令牌。
  int32 next_page_token = 3;
}

// 单条活动项。
message UserActivity {
  // 活动名。
  string event_name = 1;
  // 时间。
  google.protobuf.Timestamp timestamp = 2;
  // 上下文。
  map<string, string> properties = 3;
}

// 商品表现请求。
message GetProductPerformanceReportRequest {
  // 目标商品。
  uint64 product_id = 1;
  // 起始。
  google.protobuf.Timestamp start_date = 2;
  // 截止。
  google.protobuf.Timestamp end_date = 3;
  // 每页数量。
  int32 page_size = 4;
  // 令牌。
  int32 page_token = 5;
}

// 商品表现响应。
message ProductPerformanceReportResponse {
  // 统计序列。
  repeated ProductPerformance product_performances = 1;
  // 总笔数。
  int32 total_count = 2;
  // 令牌。
  int32 next_page_token = 3;
}

// 商品表现指标。
message ProductPerformance {
  // 商品 ID。
  uint64 product_id = 1;
  // 名称快照。
  string product_name = 2;
  // 浏览数 (PV)。
  uint64 page_views = 3;
  // 加购数。
  uint64 add_to_carts = 4;
  // 支付数。
  uint64 purchases = 5;
  // 销售额。
  double total_sales_amount = 6;
  // 综合转化率。
  double conversion_rate = 7;
}

// 销售概览请求。
message GetSalesOverviewReportRequest {
  // 开始。
  google.protobuf.Timestamp start_date = 1;
  // 结束。
  google.protobuf.Timestamp end_date = 2;
  // 聚合维度 (day, month, category)。
  optional string group_by = 3;
}

// 销售概览响应。
message SalesOverviewReportResponse {
  // 总销售额。
  double total_sales_amount = 1;
  // 总订单量。
  uint64 total_orders = 2;
  // 总售出件数。
  uint64 total_units_sold = 3;
  // 平均客单价。
  double average_order_value = 4;
  // 趋势曲线点。
  repeated SalesTrend trends = 5;
}

// 销售趋势点。
message SalesTrend {
  // 时间段标识。
  string period = 1;
  // 该段销售额。
  double sales_amount = 2;
  // 该段订单量。
  uint64 orders_count = 3;
}

// 漏斗查询请求。
message GetConversionFunnelReportRequest {
  // 开始。
  google.protobuf.Timestamp start_date = 1;
  // 结束。
  google.protobuf.Timestamp end_date = 2;
  // 漏斗定义的步骤序列。
  repeated EventType funnel_steps = 3;
}

// 漏斗报告响应。
message ConversionFunnelReportResponse {
  // 各步骤统计。
  repeated FunnelStepData funnel_data = 1;
}

// 漏斗步骤明细。
message FunnelStepData {
  // 步骤类型。
  EventType step = 1;
  // 步骤名。
  string step_name = 2;
  // 到达人数。
  uint64 count = 3;
  // 同比上步转化。
  double conversion_rate = 4;
  // 总体转化。
  double total_conversion_rate = 5;
}

// 自定义报告请求。
message GetCustomReportRequest {
  // 报告标识。
  string report_name = 1;
  // 参数集。
  map<string, string> parameters = 2;
  // 数量。
  int32 page_size = 3;
  // 令牌。
  int32 page_token = 4;
}

// 自定义报告响应。
message CustomReportResponse {
  // 数据行。
  repeated Row rows = 1;
  // 总笔数。
  int32 total_count = 2;
  // 令牌。
  int32 next_page_token = 3;
  // 列名定义。
  repeated string columns = 4;
}

// 通用数据行。
message Row {
  // 列值映射。
  map<string, string> values = 1;
}

// 行为路径请求。
message GetUserBehaviorPathRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 开始。
  google.protobuf.Timestamp start_date = 2;
  // 结束。
  google.protobuf.Timestamp end_date = 3;
  // 深度限制。
  int32 max_steps = 4;
}

// 行为路径响应。
message UserBehaviorPathResponse {
  // 路径集合。
  repeated UserBehaviorPath paths = 1;
}

// 路径模式项。
message UserBehaviorPath {
  // 环节序列。
  repeated UserActivity activities = 1;
  // 命中次数。
  uint64 count = 2;
}

// 分群查询。
message GetUserSegmentsRequest {
  // 分群规则（如消费额>100）。
  repeated string segment_criteria = 1;
  // 数量。
  int32 page_size = 2;
  // 令牌。
  int32 page_token = 3;
}

// 分群响应。
message UserSegmentsResponse {
  // 分群列表。
  repeated UserSegment segments = 1;
  // 总数。
  int32 total_count = 2;
  // 令牌。
  int32 next_page_token = 3;
}

// 用户分群。
message UserSegment {
  // 群组名。
  string segment_name = 1;
  // 成员 ID 序列。
  repeated uint64 user_ids = 2;
  // 成员总数。
  uint64 user_count = 3;
}

// 实时访客响应。
message RealtimeVisitorsResponse {
  // 实时在线人数。
  uint64 visitor_count = 1;
  // 正在活跃的 URL 列表。
  repeated string active_pages = 2;
}
