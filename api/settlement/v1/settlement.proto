syntax = "proto3";

package api.settlement.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

option go_package = "github.com/wyfcoding/ecommerce/go-api/settlement/v1;settlementv1";

service SettlementService {
  // Settlement Management
  rpc CreateSettlement(CreateSettlementRequest) returns (CreateSettlementResponse);
  rpc AddOrderToSettlement(AddOrderToSettlementRequest) returns (google.protobuf.Empty);
  rpc ProcessSettlement(ProcessSettlementRequest) returns (google.protobuf.Empty);
  rpc CompleteSettlement(CompleteSettlementRequest) returns (google.protobuf.Empty);
  rpc ListSettlements(ListSettlementsRequest) returns (ListSettlementsResponse);

  // Accounting / Ledger Integration
  rpc RecordPaymentSuccess(RecordPaymentSuccessRequest) returns (google.protobuf.Empty);

  // Account Management
  rpc GetMerchantAccount(GetMerchantAccountRequest) returns (GetMerchantAccountResponse);
}

message Settlement {
  uint64 id = 1;
  string settlement_no = 2;
  uint64 merchant_id = 3;
  string cycle = 4;
  google.protobuf.Timestamp start_date = 5;
  google.protobuf.Timestamp end_date = 6;
  int64 order_count = 7;
  uint64 total_amount = 8;
  uint64 platform_fee = 9;
  uint64 settlement_amount = 10;
  int32 status = 11;
  google.protobuf.Timestamp settled_at = 12;
  string fail_reason = 13;
  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
}

message MerchantAccount {
  uint64 id = 1;
  uint64 merchant_id = 2;
  uint64 balance = 3;
  uint64 frozen_balance = 4;
  uint64 total_income = 5;
  uint64 total_withdraw = 6;
  double fee_rate = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

message CreateSettlementRequest {
  uint64 merchant_id = 1;
  string cycle = 2;
  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;
}

message CreateSettlementResponse {
  Settlement settlement = 1;
}

message AddOrderToSettlementRequest {
  uint64 settlement_id = 1;
  uint64 order_id = 2;
  string order_no = 3;
  uint64 amount = 4;
}

message ProcessSettlementRequest {
  uint64 id = 1;
}

message CompleteSettlementRequest {
  uint64 id = 1;
}

message ListSettlementsRequest {
  uint64 merchant_id = 1;
  int32 status = 2; // -1: All
  int32 page = 3;
  int32 page_size = 4;
}

message ListSettlementsResponse {
  repeated Settlement settlements = 1;
  int64 total_count = 2;
}

message GetMerchantAccountRequest {
  uint64 merchant_id = 1;
}

message GetMerchantAccountResponse {
  MerchantAccount account = 1;
}

message RecordPaymentSuccessRequest {
  uint64 order_id = 1;
  string order_no = 2;
  uint64 merchant_id = 3;
  int64 amount = 4;
  int64 channel_cost = 5;
}
