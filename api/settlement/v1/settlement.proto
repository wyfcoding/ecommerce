syntax = "proto3";

package api.settlement.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/settlement/v1;settlementv1";

// 结算服务，负责平台与商家间的资金清算、对账及账务管理。
service Settlement {
  // 生成结算单。
  rpc CreateSettlement(CreateSettlementRequest) returns (CreateSettlementResponse);

  // 将已完成订单归入特定结算单。
  rpc AddOrderToSettlement(AddOrderToSettlementRequest) returns (google.protobuf.Empty);

  // 执行金额核算。
  rpc ProcessSettlement(ProcessSettlementRequest) returns (google.protobuf.Empty);

  // 确认资金划转完成。
  rpc CompleteSettlement(CompleteSettlementRequest) returns (google.protobuf.Empty);

  // 查询历史结算记录。
  rpc ListSettlements(ListSettlementsRequest) returns (ListSettlementsResponse);

  // 记录订单实时入账。
  rpc RecordPaymentSuccess(RecordPaymentSuccessRequest) returns (google.protobuf.Empty);

  // 获取商家实时余额及费率。
  rpc GetMerchantAccount(GetMerchantAccountRequest) returns (GetMerchantAccountResponse);
}

// 结算单详情。
message Settlement {
  // 唯一 ID。
  uint64 id = 1;
  // 结算单号。
  string settlement_no = 2;
  // 商家 ID。
  uint64 merchant_id = 3;
  // 周期名。
  string cycle = 4;
  // 开始日期。
  google.protobuf.Timestamp start_date = 5;
  // 结束日期。
  google.protobuf.Timestamp end_date = 6;
  // 订单总数。
  int64 order_count = 7;
  // 订单总额。
  uint64 total_amount = 8;
  // 平台佣金。
  uint64 platform_fee = 9;
  // 应结金额。
  uint64 settlement_amount = 10;
  // 状态。
  int32 status = 11;
  // 结算完成时刻。
  google.protobuf.Timestamp settled_at = 12;
  // 失败理由。
  string fail_reason = 13;
  // 创建时间。
  google.protobuf.Timestamp created_at = 14;
  // 修改时间。
  google.protobuf.Timestamp updated_at = 15;
}

// 商家账务。
message MerchantAccount {
  // 系统 ID。
  uint64 id = 1;
  // 商家 ID。
  uint64 merchant_id = 2;
  // 可用余额。
  uint64 balance = 3;
  // 待结算金额。
  uint64 frozen_balance = 4;
  // 累计收入。
  uint64 total_income = 5;
  // 累计提现。
  uint64 total_withdraw = 6;
  // 扣率。
  double fee_rate = 7;
  // 创建时间。
  google.protobuf.Timestamp created_at = 8;
  // 修改时间。
  google.protobuf.Timestamp updated_at = 9;
}

// 创建请求。
message CreateSettlementRequest {
  // 商家 ID。
  uint64 merchant_id = 1;
  // 周期。
  string cycle = 2;
  // 起始。
  google.protobuf.Timestamp start_date = 3;
  // 结束。
  google.protobuf.Timestamp end_date = 4;
}

// 创建结果。
message CreateSettlementResponse {
  // 结算单实体。
  Settlement settlement = 1;
}

// 关联订单请求。
message AddOrderToSettlementRequest {
  // 目标 ID。
  uint64 settlement_id = 1;
  // 订单 ID。
  uint64 order_id = 2;
  // 业务订单号。
  string order_no = 3;
  // 金额。
  uint64 amount = 4;
}

// 核算请求。
message ProcessSettlementRequest {
  // 记录 ID。
  uint64 id = 1;
}

// 完成请求。
message CompleteSettlementRequest {
  // 记录 ID。
  uint64 id = 1;
}

// 列表查询请求。
message ListSettlementsRequest {
  // 商家 ID。
  uint64 merchant_id = 1;
  // 状态筛选。
  int32 status = 2;
  // 页码。
  int32 page = 3;
  // 数量。
  int32 page_size = 4;
}

// 列表查询响应。
message ListSettlementsResponse {
  // 结算记录序列。
  repeated Settlement settlements = 1;
  // 总笔数。
  int64 total_count = 2;
}

// 账户查询请求。
message GetMerchantAccountRequest {
  // 商家 ID。
  uint64 merchant_id = 1;
}

// 账户查询响应。
message GetMerchantAccountResponse {
  // 账户档案。
  MerchantAccount account = 1;
}

// 支付同步请求。
message RecordPaymentSuccessRequest {
  // 订单 ID。
  uint64 order_id = 1;
  // 业务单号。
  string order_no = 2;
  // 商家 ID。
  uint64 merchant_id = 3;
  // 付款金额。
  int64 amount = 4;
  // 通道成本。
  int64 channel_cost = 5;
}
