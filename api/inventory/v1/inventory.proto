syntax = "proto3";

package api.inventory.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/inventory/v1;inventoryv1";

// 库存中心服务，负责全渠道库存的实时增减、锁定及日志追踪。
service InventoryService {
  // 初始化商品库存记录。
  rpc CreateInventory(CreateInventoryRequest) returns (CreateInventoryResponse);

  // 查询特定商品的库存余量。
  rpc GetInventory(GetInventoryRequest) returns (GetInventoryResponse);

  // 直接增加实物库存。
  rpc AddStock(AddStockRequest) returns (google.protobuf.Empty);

  // 直接扣减实物库存。
  rpc DeductStock(DeductStockRequest) returns (google.protobuf.Empty);

  // 预占（锁定）库存，用于下单但未支付阶段。
  rpc LockStock(LockStockRequest) returns (google.protobuf.Empty);

  // 释放预占库存。
  rpc UnlockStock(UnlockStockRequest) returns (google.protobuf.Empty);

  // 确认扣减已锁定的库存。
  rpc ConfirmDeduction(ConfirmDeductionRequest) returns (google.protobuf.Empty);

  // 分页查询库存列表。
  rpc ListInventories(ListInventoriesRequest) returns (ListInventoriesResponse);

  // 查询库存变动明细日志。
  rpc GetInventoryLogs(GetInventoryLogsRequest) returns (GetInventoryLogsResponse);
}

// 库存记录。
message Inventory {
  // 唯一 ID。
  uint64 id = 1;
  // 关联 SKU ID。
  uint64 sku_id = 2;
  // 关联商品 ID。
  uint64 product_id = 3;
  // 关联仓库 ID。
  uint64 warehouse_id = 4;
  // 可供下单的有效库存。
  int32 available_stock = 5;
  // 处于预占状态的库存。
  int32 locked_stock = 6;
  // 实物总库存。
  int32 total_stock = 7;
  // 状态。
  int32 status = 8;
  // 低库存预警阈值。
  int32 warning_threshold = 9;
  // 创建时间。
  google.protobuf.Timestamp created_at = 10;
  // 更新时间。
  google.protobuf.Timestamp updated_at = 11;
}

// 初始化库存请求。
message CreateInventoryRequest {
  // SKU ID。
  uint64 sku_id = 1;
  // 商品 ID。
  uint64 product_id = 2;
  // 仓库 ID。
  uint64 warehouse_id = 3;
  // 初始总库存。
  int32 total_stock = 4;
  // 预警阈值。
  int32 warning_threshold = 5;
}

// 响应详情。
message CreateInventoryResponse {
  // 生成的库存记录。
  Inventory inventory = 1;
}

// 查询请求。
message GetInventoryRequest {
  // SKU ID。
  uint64 sku_id = 1;
}

// 查询响应。
message GetInventoryResponse {
  // 库存数据。
  Inventory inventory = 1;
}

// 增库存请求。
message AddStockRequest {
  // SKU ID。
  uint64 sku_id = 1;
  // 增加数量。
  int32 quantity = 2;
  // 变动理由。
  string reason = 3;
}

// 减库存请求。
message DeductStockRequest {
  // SKU ID。
  uint64 sku_id = 1;
  // 扣减数量。
  int32 quantity = 2;
  // 变动理由。
  string reason = 3;
}

// 锁定库存请求。
message LockStockRequest {
  // SKU ID。
  uint64 sku_id = 1;
  // 锁定数量。
  int32 quantity = 2;
  // 锁定理由。
  string reason = 3;
}

// 解锁库存请求。
message UnlockStockRequest {
  // SKU ID。
  uint64 sku_id = 1;
  // 释放数量。
  int32 quantity = 2;
  // 解锁理由。
  string reason = 3;
}

// 确认扣减请求。
message ConfirmDeductionRequest {
  // SKU ID。
  uint64 sku_id = 1;
  // 确认数量。
  int32 quantity = 2;
  // 变动理由。
  string reason = 3;
}

// 列表查询请求。
message ListInventoriesRequest {
  // 每页数量。
  uint32 page_size = 1;
  // 页码。
  uint32 page_num = 2;
}

// 列表响应。
message ListInventoriesResponse {
  // 库存数据列表。
  repeated Inventory inventories = 1;
  // 总记录数。
  uint64 total_count = 2;
}

// 日志查询请求。
message GetInventoryLogsRequest {
  // 库存记录 ID。
  uint64 inventory_id = 1;
  // 每页数量。
  uint32 page_size = 2;
  // 页码。
  uint32 page_num = 3;
}

// 变动日志实体。
message InventoryLog {
  // 日志 ID。
  uint64 id = 1;
  // 关联库存记录 ID。
  uint64 inventory_id = 2;
  // 操作动作。
  string action = 3;
  // 变动数量。
  int32 change_quantity = 4;
  // 变动前可用数。
  int32 old_available = 5;
  // 变动后可用数。
  int32 new_available = 6;
  // 变动前锁定数。
  int32 old_locked = 7;
  // 变动后锁定数。
  int32 new_locked = 8;
  // 变动原因描述。
  string reason = 9;
  // 记录时间。
  google.protobuf.Timestamp created_at = 10;
}

// 日志响应。
message GetInventoryLogsResponse {
  // 变动记录序列。
  repeated InventoryLog logs = 1;
  // 总记录数。
  uint64 total_count = 2;
}
