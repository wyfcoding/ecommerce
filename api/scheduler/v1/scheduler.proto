syntax = "proto3";

package api.scheduler.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/scheduler/v1;schedulerv1";

// 任务调度服务，管理定时任务 (Cron Job) 的配置、状态切换及执行日志。
service SchedulerService {
  // 注册一个新的定时作业。
  rpc CreateJob(CreateJobRequest) returns (CreateJobResponse);

  // 更新作业的 Cron 表达式或参数。
  rpc UpdateJob(UpdateJobRequest) returns (google.protobuf.Empty);

  // 启用或禁用定时作业。
  rpc ToggleJobStatus(ToggleJobStatusRequest) returns (google.protobuf.Empty);

  // 手动立即触发一次作业执行。
  rpc RunJob(RunJobRequest) returns (google.protobuf.Empty);

  // 列表查询所有注册的作业。
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);

  // 查询作业的执行历史日志。
  rpc ListJobLogs(ListJobLogsRequest) returns (ListJobLogsResponse);
}

// 定时作业配置信息。
message Job {
  // 作业 ID。
  uint64 id = 1;
  // 作业名称。
  string name = 2;
  // 功能描述。
  string description = 3;
  // 定时规则 (Cron 表达式)。
  string cron_expr = 4;
  // 业务逻辑处理标识。
  string handler = 5;
  // 运行时参数。
  string params = 6;
  // 状态 (0:禁用, 1:激活)。
  int32 status = 7;
  // 上次成功运行时间。
  google.protobuf.Timestamp last_run_time = 8;
  // 预计下次触发时间。
  google.protobuf.Timestamp next_run_time = 9;
  // 累计运行次数。
  int64 run_count = 10;
  // 累计失败次数。
  int64 fail_count = 11;
  // 创建时间。
  google.protobuf.Timestamp created_at = 12;
  // 最后更新时间。
  google.protobuf.Timestamp updated_at = 13;
}

// 作业执行流水日志。
message JobLog {
  // 日志 ID。
  uint64 id = 1;
  // 关联作业 ID。
  uint64 job_id = 2;
  // 作业名称快照。
  string job_name = 3;
  // 处理标识。
  string handler = 4;
  // 执行时参数。
  string params = 5;
  // 执行状态 (SUCCESS, FAIL)。
  string status = 6;
  // 返回结果概要。
  string result = 7;
  // 错误堆栈或原因。
  string error = 8;
  // 耗时（毫秒）。
  int64 duration = 9;
  // 开始时间。
  google.protobuf.Timestamp start_time = 10;
  // 结束时间。
  google.protobuf.Timestamp end_time = 11;
  // 记录时间。
  google.protobuf.Timestamp created_at = 12;
  // 更新时间。
  google.protobuf.Timestamp updated_at = 13;
}

// 创建作业请求。
message CreateJobRequest {
  // 名称。
  string name = 1;
  // 描述。
  string description = 2;
  // Cron 规则。
  string cron_expr = 3;
  // 处理器。
  string handler = 4;
  // 参数。
  string params = 5;
}

// 创建响应。
message CreateJobResponse {
  // 生成的作业详情。
  Job job = 1;
}

// 更新请求。
message UpdateJobRequest {
  // 作业 ID。
  uint64 id = 1;
  // 新的 Cron 规则。
  string cron_expr = 2;
  // 新的参数。
  string params = 3;
}

// 状态切换请求。
message ToggleJobStatusRequest {
  // 作业 ID。
  uint64 id = 1;
  // 是否启用。
  bool enable = 2;
}

// 手动触发请求。
message RunJobRequest {
  // 作业 ID。
  uint64 id = 1;
}

// 作业列表查询请求。
message ListJobsRequest {
  // 状态过滤。
  int32 status = 1;
  // 页码。
  int32 page = 2;
  // 每页数量。
  int32 page_size = 3;
}

// 作业列表响应。
message ListJobsResponse {
  // 作业序列。
  repeated Job jobs = 1;
  // 总记录数。
  int64 total_count = 2;
}

// 日志查询请求。
message ListJobLogsRequest {
  // 针对特定作业过滤。
  uint64 job_id = 1;
  // 页码。
  int32 page = 2;
  // 每页数量。
  int32 page_size = 3;
}

// 日志查询响应。
message ListJobLogsResponse {
  // 日志序列。
  repeated JobLog logs = 1;
  // 总条数。
  int64 total_count = 2;
}
