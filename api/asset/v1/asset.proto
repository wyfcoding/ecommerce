syntax = "proto3";

package api.asset.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/asset/v1;v1";

// 资产管理服务，负责多媒体资产的生命周期、预签名授权及图像动态处理。
service Asset {
  // --- 通用存储管理 ---

  // 上传单个文件。
  rpc UploadFile(UploadFileRequest) returns (UploadFileResponse);
  // 查询文件详细属性及自定义元数据。
  rpc GetFileMetadata(GetFileMetadataRequest) returns (FileMetadataResponse);
  // 安全移除存储系统中的文件。
  rpc DeleteFile(DeleteFileRequest) returns (google.protobuf.Empty);
  // 分页检索资产库文件。
  rpc ListFiles(ListFilesRequest) returns (ListFilesResponse);
  // 为大文件或受限访问文件生成临时授权 URL。
  rpc GeneratePresignedURL(GeneratePresignedURLRequest) returns (GeneratePresignedURLResponse);

  // --- 媒体渲染处理 ---

  // 动态缩放或转换图片格式并获取 URL。
  rpc GetImageURL(GetImageURLRequest) returns (ImageURLResponse);
  // 触发一次持久化的图片处理（如裁剪、加水印）。
  rpc ProcessImage(ProcessImageRequest) returns (ProcessImageResponse);

  // --- 内容分发加速 ---

  // 刷新全网 CDN 缓存节点。
  rpc PurgeCDNCache(PurgeCDNCacheRequest) returns (google.protobuf.Empty);
}

// 资产分类。
enum FileType {
  FILE_TYPE_UNSPECIFIED = 0;
  FILE_TYPE_IMAGE = 1; // 图像
  FILE_TYPE_VIDEO = 2; // 视频/流媒体
  FILE_TYPE_DOCUMENT = 3; // PDF/文档
  FILE_TYPE_OTHER = 4; // 其他二进制
}

// 资产元数据详情。
message FileMetadata {
  // 文件全局 ID。
  string id = 1;
  // 系统保存的文件名。
  string filename = 2;
  // OSS/S3 桶名。
  string bucket = 3;
  // 桶内相对路径。
  string path = 4;
  // 持久化访问 URL。
  string url = 5;
  // 分类标签。
  FileType file_type = 6;
  // 标准 MIME 字符串。
  string mime_type = 7;
  // 字节长度。
  int64 size = 8;
  // 归属人/上传人 ID。
  uint64 uploader_id = 9;
  // 录入时间。
  google.protobuf.Timestamp uploaded_at = 10;
  // 额外的业务属性键值对。
  map<string, string> custom_metadata = 11;
}

// 上传请求。
message UploadFileRequest {
  // 文件名。
  string filename = 1;
  // 原始字节（适用于小文件）。
  bytes content = 2;
  // 显式声明分类。
  FileType file_type = 3;
  // 指定存储目录。
  optional string folder = 4;
  // 业务元数据。
  map<string, string> custom_metadata = 5;
  // 操作人。
  optional uint64 uploader_id = 6;
}

// 上传结果。
message UploadFileResponse {
  // 完备的元数据对象。
  FileMetadata file_metadata = 1;
}

// ID 查询请求。
message GetFileMetadataRequest {
  // 文件 ID。
  string id = 1;
}

// 查询响应。
message FileMetadataResponse {
  // 元数据对象。
  FileMetadata file_metadata = 1;
}

// 移除请求。
message DeleteFileRequest {
  // 目标 ID。
  string id = 1;
}

// 库检索请求。
message ListFilesRequest {
  // 数量。
  int32 page_size = 1;
  // 令牌。
  int32 page_token = 2;
  // 类型筛选。
  optional FileType file_type = 3;
  // 名字模糊搜索。
  optional string filename_keyword = 4;
  // 所属人筛选。
  optional uint64 uploader_id = 5;
  // 起止时间。
  optional google.protobuf.Timestamp start_date = 6;
  optional google.protobuf.Timestamp end_date = 7;
}

// 库检索响应。
message ListFilesResponse {
  // 文件对象列表。
  repeated FileMetadata files = 1;
  // 总计数。
  int32 total_count = 2;
  // 翻页令牌。
  int32 next_page_token = 3;
}

// 授权链接类型。
enum PresignedURLType {
  PRESIGNED_URL_TYPE_UNSPECIFIED = 0;
  PRESIGNED_URL_TYPE_UPLOAD = 1; // 授权直传
  PRESIGNED_URL_TYPE_DOWNLOAD = 2; // 授权下载/查看
}

// 预签名请求。
message GeneratePresignedURLRequest {
  // 期望文件名。
  string filename = 1;
  // 操作意图。
  PresignedURLType type = 2;
  // MIME 校验（上传必填）。
  optional string content_type = 3;
  // 有效期秒数。
  optional int64 expires_in_seconds = 4;
  // 下载的目标 ID。
  optional string file_id = 5;
}

// 授权响应。
message GeneratePresignedURLResponse {
  // 具备授权参数的 URL。
  string url = 1;
  // 预生成的 ID。
  string file_id = 2;
}

// 图像编码。
enum ImageFormat {
  IMAGE_FORMAT_UNSPECIFIED = 0;
  IMAGE_FORMAT_JPEG = 1;
  IMAGE_FORMAT_PNG = 2;
  IMAGE_FORMAT_WEBP = 3;
}

// 动态处理请求。
message GetImageURLRequest {
  // 原图 ID。
  string file_id = 1;
  // 目标宽。
  optional int32 width = 2;
  // 目标高。
  optional int32 height = 3;
  // 指定格式。
  optional ImageFormat format = 4;
  // 是否自动裁切以适配宽高。
  optional bool crop = 5;
}

// 处理后 URL。
message ImageURLResponse {
  // 经 CDN 处理的地址。
  string url = 1;
}

// 操作指令。
enum ImageProcessOperation {
  IMAGE_PROCESS_OPERATION_UNSPECIFIED = 0;
  IMAGE_PROCESS_OPERATION_RESIZE = 1; // 缩放
  IMAGE_PROCESS_OPERATION_CROP = 2; // 裁剪
  IMAGE_PROCESS_OPERATION_WATERMARK = 3; // 水印
}

// 持久化处理请求。
message ProcessImageRequest {
  // 原图 ID。
  string file_id = 1;
  // 指令。
  ImageProcessOperation operation = 2;
  // 参数集（如水印文字等）。
  map<string, string> params = 3;
}

// 持久化结果。
message ProcessImageResponse {
  // 预览地址。
  string processed_image_url = 1;
  // 若生成新文件则返回其 ID。
  string processed_file_id = 2;
}

// 缓存刷新请求。
message PurgeCDNCacheRequest {
  // 资源地址集。
  repeated string urls = 1;
  // 是否刷掉全部（风险操作）。
  optional bool purge_all = 2;
}
