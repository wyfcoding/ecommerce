syntax = "proto3";

package api.flashsale.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/flashsale/v1;flashsalev1";

// 秒杀服务，处理高并发下的限时抢购活动、库存扣减及资格校验。
service FlashSaleService {
  // 录入新的秒杀活动场次。
  rpc CreateFlashSaleEvent(CreateFlashSaleEventRequest) returns (CreateFlashSaleEventResponse);

  // 查询特定活动场次的详情。
  rpc GetFlashSaleEvent(GetFlashSaleEventRequest) returns (GetFlashSaleEventResponse);

  // 获取当前正在进行或即将开始的秒杀列表。
  rpc ListActiveFlashSaleEvents(ListActiveFlashSaleEventsRequest) returns (ListActiveFlashSaleEventsResponse);

  // 用户下单参与秒杀（核心高并发接口）。
  rpc ParticipateInFlashSale(ParticipateInFlashSaleRequest) returns (ParticipateInFlashSaleResponse);

  // 获取单件秒杀商品的库存及限购详情。
  rpc GetFlashSaleProductDetails(GetFlashSaleProductDetailsRequest) returns (GetFlashSaleProductDetailsResponse);
}

// 秒杀活动场次。
message FlashSaleEvent {
  // 系统 ID。
  string id = 1;
  // 活动标题。
  string name = 2;
  // 详细说明。
  string description = 3;
  // 场次开始时间。
  google.protobuf.Timestamp start_time = 4;
  // 场次结束时间。
  google.protobuf.Timestamp end_time = 5;
  // 状态 (UPCOMING, ONGOING, FINISHED)。
  string status = 6;
  // 该场次包含的特价商品。
  repeated FlashSaleProduct products = 7;
  // 创建时间。
  google.protobuf.Timestamp created_at = 8;
  // 修改时间。
  google.protobuf.Timestamp updated_at = 9;
}

// 秒杀商品明细。
message FlashSaleProduct {
  // 商品 ID。
  string product_id = 1;
  // 秒杀特价。
  double flash_price = 2;
  // 总投放库存。
  int32 total_stock = 3;
  // 当前剩余库存。
  int32 remaining_stock = 4;
  // 单用户限购数量。
  int32 max_per_user = 5;
}

// 创建活动请求。
message CreateFlashSaleEventRequest {
  // 标题。
  string name = 1;
  // 描述。
  string description = 2;
  // 开始时间。
  google.protobuf.Timestamp start_time = 3;
  // 结束时间。
  google.protobuf.Timestamp end_time = 4;
  // 商品清单。
  repeated FlashSaleProduct products = 5;
}

// 创建响应。
message CreateFlashSaleEventResponse {
  // 活动实体。
  FlashSaleEvent event = 1;
}

// 查询请求。
message GetFlashSaleEventRequest {
  // 活动 ID。
  string id = 1;
}

// 查询响应。
message GetFlashSaleEventResponse {
  // 活动实体。
  FlashSaleEvent event = 1;
}

// 活跃列表请求。
message ListActiveFlashSaleEventsRequest {}

// 活跃列表响应。
message ListActiveFlashSaleEventsResponse {
  // 活动序列。
  repeated FlashSaleEvent events = 1;
  // 总笔数。
  int32 total_count = 2;
}

// 抢购请求。
message ParticipateInFlashSaleRequest {
  // 活动场次 ID。
  string event_id = 1;
  // 商品 ID。
  string product_id = 2;
  // 用户 ID。
  string user_id = 3;
  // 数量。
  int32 quantity = 4;
}

// 抢购结果。
message ParticipateInFlashSaleResponse {
  // 生成的预订单 ID。
  string order_id = 1;
  // 处理结果状态。
  string status = 2;
  // 提示消息。
  string message = 3;
}

// 商品详情请求。
message GetFlashSaleProductDetailsRequest {
  // 活动 ID。
  string event_id = 1;
  // 商品 ID。
  string product_id = 2;
}

// 商品详情响应。
message GetFlashSaleProductDetailsResponse {
  // 规格详情。
  FlashSaleProduct product = 1;
}
