syntax = "proto3";

package api.loyalty.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/wyfcoding/ecommerce/goapi/loyalty/v1;v1";

// 忠诚度与会员权益服务，负责积分体系、会员等级及专属折扣管理。
service Loyalty {
  // 查询用户的会员档案、等级状态及积分余额。
  rpc GetMemberAccount(GetMemberAccountRequest) returns (GetMemberAccountResponse);

  // 系统或手动增加用户账户积分。
  rpc AddPoints(AddPointsRequest) returns (google.protobuf.Empty);

  // 扣减用户已持有的积分。
  rpc DeductPoints(DeductPointsRequest) returns (google.protobuf.Empty);

  // 补录用户的消费额，用于等级晋升逻辑。
  rpc AddSpent(AddSpentRequest) returns (google.protobuf.Empty);

  // 查询积分的来源与消耗流水记录。
  rpc ListPointsTransactions(ListPointsTransactionsRequest) returns (ListPointsTransactionsResponse);

  // 定义并添加特定等级的会员专属权益。
  rpc AddBenefit(AddBenefitRequest) returns (AddBenefitResponse);

  // 获取各等级生效的权益配置列表。
  rpc ListBenefits(ListBenefitsRequest) returns (ListBenefitsResponse);

  // 撤销/删除特定的权益条目。
  rpc DeleteBenefit(DeleteBenefitRequest) returns (google.protobuf.Empty);
}

// 会员账户信息。
message MemberAccount {
  // 系统 ID。
  uint64 id = 1;
  // 归属用户。
  uint64 user_id = 2;
  // 等级名。
  string level = 3;
  // 累计获赠总分。
  int64 total_points = 4;
  // 实时可用余额。
  int64 available_points = 5;
  // 待结算/冻结积分。
  int64 frozen_points = 6;
  // 累计成功消费金额。
  uint64 total_spent = 7;
  // 创建时间。
  google.protobuf.Timestamp created_at = 8;
  // 修改时间。
  google.protobuf.Timestamp updated_at = 9;
}

// 积分交易流水。
message PointsTransaction {
  // 流水 ID。
  uint64 id = 1;
  // 行为用户。
  uint64 user_id = 2;
  // 类别 (EARN, REDEEM)。
  string transaction_type = 3;
  // 数值。
  int64 points = 4;
  // 变动后结余。
  int64 balance = 5;
  // 关联业务订单 ID。
  uint64 order_id = 6;
  // 说明。
  string description = 7;
  // 该笔积分有效期点。
  google.protobuf.Timestamp expire_at = 8;
  // 发生时刻。
  google.protobuf.Timestamp created_at = 9;
}

// 等级权益配置。
message MemberBenefit {
  // 权益 ID。
  uint64 id = 1;
  // 目标会员级。
  string level = 2;
  // 权益标题。
  string name = 3;
  // 详细权益介绍。
  string description = 4;
  // 专享折扣率（如 0.9）。
  double discount_rate = 5;
  // 积分加倍倍率。
  double points_rate = 6;
  // 状态开关。
  bool enabled = 7;
  // 录入时间。
  google.protobuf.Timestamp created_at = 8;
  // 更新时间。
  google.protobuf.Timestamp updated_at = 9;
}

// 账户查询。
message GetMemberAccountRequest {
  // 用户 ID。
  uint64 user_id = 1;
}

// 账户响应。
message GetMemberAccountResponse {
  // 账户档案。
  MemberAccount account = 1;
}

// 积分发放请求。
message AddPointsRequest {
  // 目标用户。
  uint64 user_id = 1;
  // 增量值。
  int64 points = 2;
  // 业务动作标识。
  string transaction_type = 3;
  // 摘要说明。
  string description = 4;
  // 关联单号。
  uint64 order_id = 5;
}

// 积分扣减请求。
message DeductPointsRequest {
  // 目标用户。
  uint64 user_id = 1;
  // 减量值。
  int64 points = 2;
  // 业务标识。
  string transaction_type = 3;
  // 说明。
  string description = 4;
  // 关联单号。
  uint64 order_id = 5;
}

// 消费额更新请求。
message AddSpentRequest {
  // 目标用户。
  uint64 user_id = 1;
  // 累计增加金额。
  uint64 amount = 2;
}

// 流水查询请求。
message ListPointsTransactionsRequest {
  // 用户 ID。
  uint64 user_id = 1;
  // 数量。
  uint32 page_size = 2;
  // 页码。
  uint32 page_num = 3;
}

// 流水查询响应。
message ListPointsTransactionsResponse {
  // 流水序列。
  repeated PointsTransaction transactions = 1;
  // 总笔数。
  uint64 total_count = 2;
}

// 权益创建。
message AddBenefitRequest {
  // 适用等级。
  string level = 1;
  // 名称。
  string name = 2;
  // 描述。
  string description = 3;
  // 折扣值。
  double discount_rate = 4;
  // 积分率。
  double points_rate = 5;
}

// 权益创建响应。
message AddBenefitResponse {
  // 权益条目。
  MemberBenefit benefit = 1;
}

// 权益检索。
message ListBenefitsRequest {
  // 等级名。
  string level = 1;
}

// 权益响应。
message ListBenefitsResponse {
  // 权益列表。
  repeated MemberBenefit benefits = 1;
}

// 权益移除。
message DeleteBenefitRequest {
  // 权益 ID。
  uint64 id = 1;
}
