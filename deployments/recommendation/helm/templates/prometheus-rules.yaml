apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "recommendation.fullname" . }}-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    role: alert-rules
    {{- include "recommendation.labels" . | nindent 4 }}
spec:
  groups:
  - name: recommendation.rules
    rules:
    # 1. 黄金指标：错误率告警
    - alert: RecommendationServiceHighHttpErrorRate
      expr: |
        sum(rate(http_request_duration_seconds_count{service="{{ include "recommendation.fullname" . }}", status=~"5.."}[5m])) 
        / 
        sum(rate(http_request_duration_seconds_count{service="{{ include "recommendation.fullname" . }}"}[5m])) > 0.05
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Recommendation Service high HTTP error rate"
        description: "HTTP 5xx error rate is over 5% for more than 2 minutes (current value: {{ $value | printf "%.2f" }})"

    # 2. 黄金指标：延迟告警 (P99 > 1s)
    - alert: RecommendationServiceHighLatency
      expr: |
        histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket{service="{{ include "recommendation.fullname" . }}"}[5m]))) > 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Recommendation Service P99 latency high"
        description: "P99 latency is over 1s for 5 minutes (current value: {{ $value }}s)"

    # 3. 业务指标：分布式事务 Saga 失败告警
    - alert: RecommendationSagaTransactionFailure
      expr: |
        sum(rate(dtm_saga_status_total{service="{{ include "recommendation.fullname" . }}", status="failed"}[5m])) > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "Recommendation Distributed Transaction (Saga) failed"
        description: "Detected failed Saga transactions in recommendation service. Immediate manual intervention may be required."

    # 4. 资源指标：HPA 满载告警
    - alert: RecommendationServiceHPAMaxedOut
      expr: |
        kube_horizontalpodautoscaler_status_current_replicas{horizontalpodautoscaler="{{ include "recommendation.fullname" . }}"} 
        == 
        kube_horizontalpodautoscaler_spec_max_replicas{horizontalpodautoscaler="{{ include "recommendation.fullname" . }}"}
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Recommendation Service HPA at maximum capacity"
        description: "The HPA has reached its maximum replica count. Service might be under-provisioned."
