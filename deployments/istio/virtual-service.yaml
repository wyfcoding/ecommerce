apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service
  namespace: ecommerce
spec:
  hosts:
  - user-service
  - api.ecommerce.com
  gateways:
  - ecommerce-gateway
  - mesh
  http:
  # 金丝雀发布：10% 流量到 v2
  - match:
    - uri:
        prefix: /api/v1/users
    route:
    - destination:
        host: user-service
        subset: v1
        port:
          number: 8080
      weight: 90
    - destination:
        host: user-service
        subset: v2
        port:
          number: 8080
      weight: 10
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: product-service
  namespace: ecommerce
spec:
  hosts:
  - product-service
  - api.ecommerce.com
  gateways:
  - ecommerce-gateway
  - mesh
  http:
  - match:
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: product-service
        subset: v1
        port:
          number: 8083
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  - match:
    - uri:
        prefix: /api/v1/carts
    route:
    - destination:
        host: cart-service
        subset: v1
        port:
          number: 8084
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  - match:
    - uri:
        prefix: /api/v1/inventory
    route:
    - destination:
        host: inventory-service
        subset: v1
        port:
          number: 8085
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  - match:
    - uri:
        prefix: /api/v1/payments
    route:
    - destination:
        host: payment-service
        subset: v1
        port:
          number: 8086
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  - match:
    - uri:
        prefix: /api/v1/logistics
    route:
    - destination:
        host: logistics-service
        subset: v1
        port:
          number: 8087
      weight: 100
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service
  namespace: ecommerce
spec:
  hosts:
  - order-service
  - api.ecommerce.com
  gateways:
  - ecommerce-gateway
  - mesh
  http:
  - match:
    - uri:
        prefix: /api/v1/orders
    route:
    - destination:
        host: order-service
        subset: v1
        port:
          number: 8082
      weight: 100
    timeout: 60s
    retries:
      attempts: 2
      perTryTimeout: 30s
